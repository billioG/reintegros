<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reintegro de Gastos PWA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Animaciones */
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #0ea5e9;
            box-shadow: 0 0 10px #0ea5e9;
            animation: scan 2s infinite linear;
            display: none;
        }

        .loader {
            border-top-color: #0ea5e9;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Transitions */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow: hidden;
        }

        input[type="file"] { display: none; }
    </style>
</head>
<body class="pb-32"> <!-- Aumentado padding bottom para barra de 3 botones -->

    <!-- Header -->
    <header class="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <span class="material-icons-round">receipt_long</span>
                Reintegro de Gastos
            </h1>
            <div class="flex items-center gap-3">
                <button onclick="toggleConfigModal()" class="text-white hover:bg-teal-700 rounded-full p-1 transition">
                    <span class="material-icons-round">settings</span>
                </button>
                <div class="text-xs opacity-80 bg-teal-700 px-2 py-1 rounded">
                    v2.4
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4">

        <!-- Sección de Cámara -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 text-center border-2 border-dashed border-gray-300 relative overflow-hidden" id="camera-section">
            <div class="scanner-line" id="scanner-line"></div>
            
            <div id="preview-container" class="hidden mb-4 relative">
                <img id="image-preview" class="mx-auto max-h-64 rounded-lg shadow-md object-contain" alt="Vista previa factura">
                <button onclick="resetImage()" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full shadow hover:bg-red-600 transition">
                    <span class="material-icons-round text-sm">close</span>
                </button>
                <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                    <span id="img-size-info">0 KB</span>
                </div>
            </div>

            <div id="upload-placeholder">
                <div class="bg-teal-50 text-teal-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="material-icons-round text-3xl">add_a_photo</span>
                </div>
                <h2 class="text-gray-800 font-medium mb-1">Escanear DTE / Factura</h2>
                <p class="text-gray-500 text-sm mb-4">Captura Fecha, DTE No. y Total</p>
                
                <label for="camera-input" class="inline-flex items-center gap-2 bg-teal-600 text-white px-6 py-3 rounded-full font-semibold shadow-lg active:scale-95 transition cursor-pointer hover:bg-teal-700">
                    <span class="material-icons-round">camera_alt</span>
                    Abrir Cámara
                </label>
                <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
            </div>

            <!-- OCR Loading -->
            <div id="ocr-loading" class="hidden mt-4">
                <div class="flex justify-center items-center gap-3">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div>
                    <span class="text-sm text-gray-600 font-medium" id="ocr-status-text">Analizando imagen...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3">
                    <div class="bg-teal-600 h-1.5 rounded-full" id="ocr-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Formulario -->
        <form id="expense-form" class="bg-white rounded-xl shadow-sm p-5 space-y-4" onsubmit="saveExpense(event)">
            <h3 class="text-gray-800 font-bold border-b pb-2 mb-2 flex items-center gap-2">
                <span class="material-icons-round text-teal-600">edit_note</span>
                Detalles del Reintegro
            </h3>

            <!-- Fila: Fecha y Doc No -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Fecha</label>
                    <input type="date" id="date" required class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Doc. No. / DTE</label>
                    <input type="text" id="docNo" placeholder="Ej: 89E129EE..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5 font-mono text-sm">
                </div>
            </div>

            <!-- Descripción -->
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Descripción del Gasto</label>
                <input type="text" id="description" required placeholder="Ej: Compra de materiales..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5">
            </div>

            <!-- Proyecto y Solicitante -->
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Proyecto</label>
                    <!-- Select Principal -->
                    <select id="project" onchange="toggleOtherProject()" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5">
                        <option value="1bot">1bot</option>
                        <option value="BI">BI</option>
                        <option value="ATT">ATT</option>
                        <option value="Admin">Administración</option>
                        <option value="Otro">Otro...</option>
                    </select>
                    <!-- Input oculto para "Otro" -->
                    <input type="text" id="otherProjectInput" placeholder="Especifique proyecto" class="hidden w-full bg-white border border-teal-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5 text-sm animate-fade-in">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Solicitante</label>
                    <input type="text" id="requester" value="Billy" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5">
                </div>
            </div>

            <!-- Valor Total -->
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Valor Total (Q)</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <span class="text-gray-500 font-bold">Q</span>
                    </div>
                    <input type="number" id="amount" step="0.01" required placeholder="0.00" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-lg font-bold rounded-lg focus:ring-teal-500 focus:border-teal-500 p-2.5 pl-8">
                </div>
            </div>

            <!-- Botón Guardar -->
            <button type="submit" class="w-full text-white bg-teal-600 hover:bg-teal-700 focus:ring-4 focus:ring-teal-300 font-medium rounded-lg text-sm px-5 py-3.5 text-center flex justify-center items-center gap-2 shadow-lg mt-2 transition-all">
                <span class="material-icons-round">save</span>
                Guardar Registro
            </button>
        </form>

        <!-- Historial -->
        <div class="mt-8 mb-24">
            <div class="flex justify-between items-end mb-4">
                <h3 class="text-lg font-bold text-gray-800">Registros Pendientes</h3>
                <button onclick="clearData()" class="text-xs text-red-500 underline">Limpiar todo</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 mb-4">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-3 py-3">Fecha</th>
                                <th scope="col" class="px-3 py-3">Desc.</th>
                                <th scope="col" class="px-3 py-3 text-right">Valor</th>
                                <th scope="col" class="px-2 py-3"></th>
                            </tr>
                        </thead>
                        <tbody id="expense-list">
                            <tr><td colspan="4" class="text-center py-4 text-gray-400">Sin registros</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-50 px-4 py-2 border-t text-right font-bold text-gray-700" id="total-sum">
                    Total: Q0.00
                </div>
            </div>
            
        </div>

    </main>

    <!-- Barra Inferior de Sincronización (Sticky) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-3 z-40">
        <div class="max-w-2xl mx-auto flex gap-2">
             <button onclick="exportToCSV()" class="flex-1 bg-gray-100 text-gray-700 font-medium py-3 rounded-lg flex flex-col justify-center items-center gap-1 active:bg-gray-200 transition text-xs">
                <span class="material-icons-round text-gray-500 text-base">file_download</span>
                CSV
            </button>
            <button onclick="openSheet()" class="flex-1 bg-blue-50 text-blue-700 font-medium py-3 rounded-lg flex flex-col justify-center items-center gap-1 active:bg-blue-100 transition text-xs border border-blue-100">
                <span class="material-icons-round text-base">open_in_new</span>
                Ver Hoja
            </button>
            <button onclick="syncToSheet()" id="btn-sync" class="flex-[2] bg-green-600 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2 shadow-lg hover:bg-green-700 active:scale-95 transition text-sm">
                <span class="material-icons-round">sync</span>
                Sincronizar
            </button>
        </div>
    </div>

    <!-- Modal Configuración -->
    <div id="config-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleConfigModal()"></div>
        
        <div class="modal-container bg-white w-11/12 max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto animate-bounce-in">
            <div class="modal-content py-4 text-left px-6">
                <!--Title-->
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <p class="text-xl font-bold text-gray-800">Configuración</p>
                    <div class="cursor-pointer z-50" onclick="toggleConfigModal()">
                        <span class="material-icons-round text-gray-500">close</span>
                    </div>
                </div>

                <!--Body-->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">URL del Google Apps Script</label>
                    <p class="text-xs text-gray-500 mb-2">
                        Pega aquí la URL de la aplicación web implementada (termina en <code>/exec</code>).
                        <br><span class="text-red-500 font-semibold">*No pegues la URL de la hoja de cálculo.</span>
                    </p>
                    <input type="text" id="script-url-input" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-teal-500 focus:border-teal-500" placeholder="https://script.google.com/macros/s/...">
                </div>

                <!--Footer-->
                <div class="flex justify-end pt-2">
                    <button onclick="saveConfig()" class="px-4 py-2 bg-teal-600 p-3 rounded-lg text-white hover:bg-teal-700 font-bold w-full">Guardar Configuración</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-xl text-sm transition-opacity duration-300 opacity-0 pointer-events-none z-50 flex items-center gap-3 w-max max-w-[90%]">
        <span class="material-icons-round text-green-400">check_circle</span>
        <span id="toast-message">Mensaje</span>
    </div>

    <!-- Loading Overlay para Sincronización -->
    <div id="sync-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[70] hidden flex flex-col justify-center items-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-white font-bold text-lg animate-pulse" id="sync-status">Sincronizando...</p>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        // URL ACTUALIZADA POR EL USUARIO
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzb2303oJU_uneHezhd4H7UmPZvfGbDebrsCC-yCSUPTawbnC7YJYUNfYtP0z7RY_mH/exec";
        
        
        // Usar la guardada o la default
        let SCRIPT_URL = localStorage.getItem('googleScriptUrl') || DEFAULT_SCRIPT_URL;
        
        let currentImageCompressed = null; // Almacena la imagen actual en memoria
        
        // URL Específica solicitada por el usuario para visualización
        const SHEET_VIEW_URL = "https://docs.google.com/spreadsheets/d/19Dn2iYHZr9wrPYdNEI2t6QMLMSK-Ljshu_bpCyzgY78/edit?gid=230086021#gid=230086021";

        document.addEventListener('DOMContentLoaded', () => {
            renderList();
            document.getElementById('date').valueAsDate = new Date();
            // Mostrar la URL actual en el input
            document.getElementById('script-url-input').value = SCRIPT_URL;
        });

        // --- FUNCIONES NUEVAS ---
        function openSheet() {
            window.open(SHEET_VIEW_URL, '_blank');
        }

        // --- LÓGICA DE CONFIGURACIÓN ---
        function toggleConfigModal() {
            const modal = document.getElementById('config-modal');
            const body = document.querySelector('body');
            
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            body.classList.toggle('modal-active');
        }

        function saveConfig() {
            const url = document.getElementById('script-url-input').value.trim();
            
            // Validación inteligente: Si el usuario pega la URL de docs.google.com en vez del script
            if (url.includes("docs.google.com") || url.includes("spreadsheets")) {
                alert("¡Atención!\n\nHas pegado la URL de la Hoja de Cálculo.\n\nPara que la sincronización automática funcione, necesitas la URL del 'Script' que generaste (termina en /exec).\n\nLa URL de la hoja ya está configurada en el botón 'Ver Hoja'.");
                return;
            }

            if(url) {
                localStorage.setItem('googleScriptUrl', url);
                SCRIPT_URL = url;
                showToast("Configuración guardada");
                toggleConfigModal();
            } else {
                showToast("La URL no puede estar vacía", true);
            }
        }

        function toggleOtherProject() {
            const select = document.getElementById('project');
            const input = document.getElementById('otherProjectInput');
            if (select.value === 'Otro') {
                input.classList.remove('hidden');
                input.focus();
                input.required = true;
            } else {
                input.classList.add('hidden');
                input.required = false;
            }
        }

        // --- MANEJO DE IMAGEN Y COMPRESIÓN ---
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. Mostrar preview inmediato
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('upload-placeholder').classList.add('hidden');
                document.getElementById('preview-container').classList.remove('hidden');
            }
            reader.readAsDataURL(file);

            // 2. Comprimir imagen para almacenamiento y envío
            try {
                const compressedBase64 = await compressImage(file);
                currentImageCompressed = compressedBase64;
                
                // Mostrar tamaño aproximado
                const sizeKB = Math.round((compressedBase64.length * 3 / 4) / 1024);
                document.getElementById('img-size-info').innerText = sizeKB + ' KB';

                // 3. Iniciar OCR sobre la imagen
                runOCR(file); 

            } catch (err) {
                console.error("Error comprimiendo", err);
                showToast("Error procesando imagen", true);
            }
        }

        // Función Helper para redimensionar imágenes (Canvas)
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 800; // Ancho máximo para no saturar localStorage
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const elem = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }

                        elem.width = width;
                        elem.height = height;
                        const ctx = elem.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Retorna base64 JPEG calidad 0.6
                        resolve(elem.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = error => reject(error);
                };
            });
        }

        async function runOCR(file) {
            document.getElementById('ocr-loading').classList.remove('hidden');
            document.getElementById('scanner-line').style.display = 'block';

            try {
                const result = await Tesseract.recognize(file, 'spa', {
                    logger: m => {
                        if(m.status === 'recognizing text'){
                            const pct = Math.round(m.progress * 100);
                            document.getElementById('ocr-progress').style.width = pct + '%';
                            document.getElementById('ocr-status-text').innerText = `Analizando... ${pct}%`;
                        }
                    }
                });
                processOCRText(result.data.text);
            } catch (error) {
                console.error(error);
                showToast("No se pudo leer la imagen automáticamente.", true);
            } finally {
                document.getElementById('ocr-loading').classList.add('hidden');
                document.getElementById('scanner-line').style.display = 'none';
            }
        }

        function resetImage() {
            document.getElementById('camera-input').value = "";
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('expense-form').reset();
            document.getElementById('date').valueAsDate = new Date();
            toggleOtherProject(); 
            document.getElementById('ocr-progress').style.width = '0%';
            currentImageCompressed = null;
        }

        function processOCRText(text) {
            console.log("OCR RAW:", text);
            const cleanText = text.replace(/[\r\n]+/g, '\n'); 
            const lines = cleanText.split('\n');

            // 1. Total (Busca montos con Q o al final)
            const moneyMatches = cleanText.match(/[0-9]{1,3}(?:[,.][0-9]{3})*[.,][0-9]{2}/g);
            if (moneyMatches) {
                const values = moneyMatches.map(v => parseFloat(v.replace(/,/g, ''))); 
                const maxVal = Math.max(...values.filter(v => !isNaN(v)));
                if(maxVal > 0) document.getElementById('amount').value = maxVal.toFixed(2);
            }
            
            // 2. Fecha
            const dateMatch = cleanText.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
            if (dateMatch) {
                let y = dateMatch[3];
                if(y.length === 2) y = "20" + y;
                document.getElementById('date').value = `${y}-${dateMatch[2].padStart(2,'0')}-${dateMatch[1].padStart(2,'0')}`;
            }
            
            // 3. DTE (Lógica mejorada: Busca "Serie" y mira la línea SIGUIENTE)
            let dteFound = "";
            const uuidRegex = /\b[A-F0-9]{8,}(?:-[A-F0-9]{4})?\b/i; // Patrón UUID
            const keywordRegex = /(?:serie|número|numero|dte|factura)/i;

            for (let i = 0; i < lines.length; i++) {
                // Si la línea actual contiene la palabra clave
                if (keywordRegex.test(lines[i])) {
                    // Primero, buscar en la MISMA línea si está separado por :
                    let matchSameLine = lines[i].match(uuidRegex);
                    if (matchSameLine && matchSameLine[0].length > 6) {
                         dteFound = matchSameLine[0];
                         break;
                    }
                    
                    // Si no, buscar en la línea SIGUIENTE (i+1)
                    if (i + 1 < lines.length) {
                        let nextLine = lines[i + 1];
                        let matchNextLine = nextLine.match(uuidRegex);
                        if (matchNextLine) {
                            dteFound = matchNextLine[0];
                            break;
                        }
                    }
                }
            }

            // Fallback: Si no se encontró con el método de "línea siguiente", buscar cualquier UUID en todo el texto
            if (!dteFound) {
                 const matchB = cleanText.match(uuidRegex);
                 if (matchB) dteFound = matchB[0];
            }

            if (dteFound) {
                document.getElementById('docNo').value = dteFound;
                showToast("¡DTE detectado!");
            }
        }

        // --- GUARDADO LOCAL ---
        function saveExpense(e) {
            e.preventDefault();
            
            const projectSelect = document.getElementById('project');
            const projectOther = document.getElementById('otherProjectInput');
            const finalProject = (projectSelect.value === 'Otro') ? projectOther.value : projectSelect.value;

            if(!finalProject) { showToast("Especifica el nombre del proyecto", true); return; }

            // Validar tamaño de localStorage (Max ~5MB)
            // Si la imagen comprimida pesa 100kb, podemos guardar ~50 recibos.
            
            const expense = {
                id: Date.now(),
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                docNo: document.getElementById('docNo').value || "S/N",
                project: finalProject, 
                amount: parseFloat(document.getElementById('amount').value),
                requester: document.getElementById('requester').value,
                image: currentImageCompressed // Guardamos la versión comprimida
            };

            try {
                expenses.push(expense);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                renderList();
                resetImage();
                showToast("Guardado (con foto)");
            } catch (err) {
                if (err.name === 'QuotaExceededError') {
                    showToast("¡Memoria llena! Sincroniza o borra registros.", true);
                    expenses.pop(); // Revertir push
                } else {
                    console.error(err);
                }
            }
        }

        function renderList() {
            const list = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-sum');
            
            if (expenses.length === 0) {
                list.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400 text-xs italic">No hay facturas pendientes</td></tr>';
                totalEl.innerText = "Total: Q0.00";
                return;
            }

            let html = '';
            let total = 0;

            expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                total += item.amount;
                const d = new Date(item.date + 'T00:00:00');
                const displayDate = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
                
                // Icono de foto si existe
                const photoIcon = item.image ? '<span class="material-icons-round text-xs text-teal-500">photo_camera</span>' : '';

                html += `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-3 py-3 font-medium text-gray-900">${displayDate}</td>
                    <td class="px-3 py-3">
                        <div class="truncate max-w-[100px] font-medium flex items-center gap-1">${item.description} ${photoIcon}</div>
                        <div class="text-[10px] text-gray-400">${item.project}</div>
                    </td>
                    <td class="px-3 py-3 text-right font-bold text-teal-600">Q${item.amount.toFixed(2)}</td>
                    <td class="px-2 py-3 text-center">
                        <button onclick="deleteExpense(${item.id})" class="text-gray-300 hover:text-red-500 transition">
                            <span class="material-icons-round text-lg">close</span>
                        </button>
                    </td>
                </tr>
                `;
            });

            list.innerHTML = html;
            totalEl.innerText = `Total: Q${total.toFixed(2)}`;
        }

        function deleteExpense(id) {
            if(confirm('¿Eliminar registro?')) {
                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                renderList();
            }
        }

        function clearData() {
            if(confirm('¿Borrar TODO el historial local?')) {
                expenses = [];
                localStorage.removeItem('expenses');
                renderList();
            }
        }

        // --- SINCRONIZACIÓN AUTOMÁTICA ---
        function syncToSheet() {
            if (expenses.length === 0) { showToast("Nada que sincronizar", true); return; }
            if (!SCRIPT_URL) {
                toggleConfigModal();
                alert("Falta configuración. Ingresa la URL del Script.");
                return;
            }

            const statusEl = document.getElementById('sync-status');
            const overlay = document.getElementById('sync-overlay');
            overlay.classList.remove('hidden');
            statusEl.innerText = `Subiendo ${expenses.length} facturas...`;

            // Preparar payload
            const dataPayload = expenses.map(row => {
                const d = row.date.split('-'); 
                return {
                    formattedDate: `${d[2]}/${d[1]}`, // DD/MM
                    description: row.description,
                    docNo: row.docNo,
                    project: row.project,
                    amount: row.amount,
                    requester: row.requester,
                    image: row.image // Base64 comprimido
                };
            });

            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dataPayload)
            })
            .then(() => {
                overlay.classList.add('hidden');
                if(confirm('¡Enviado a Drive con éxito!\n\nSe han subido los datos y las fotos.\n¿Limpiar lista local?')) {
                    expenses = [];
                    localStorage.setItem('expenses', JSON.stringify([]));
                    renderList();
                }
            })
            .catch(error => {
                overlay.classList.add('hidden');
                console.error("Error:", error);
                alert("Error de conexión. Verifica la URL o tu internet.");
            });
        }

        function exportToCSV() {
            if (expenses.length === 0) return;
            let csvContent = "data:text/csv;charset=utf-8,Fecha,Descripción,Doc No,Proyecto,Valor,Solicitante\n";
            expenses.forEach(r => {
                csvContent += `${r.date},"${r.description}","${r.docNo}",${r.project},Q${r.amount.toFixed(2)},${r.requester}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reintegro_gastos.csv");
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const icon = toast.querySelector('.material-icons-round');
            
            msgEl.innerText = msg;
            icon.innerText = isError ? 'error_outline' : 'check_circle';
            icon.className = `material-icons-round ${isError ? 'text-red-400' : 'text-green-400'}`;

            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 4000);
        }

    </script>
</body>
</html>
