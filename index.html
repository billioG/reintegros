<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reintegro de Gastos PWA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librerías Externas -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script> <!-- OCR -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script> <!-- Cropper -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Gráficos Dashboard -->

    <!-- Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .scanner-line { position: absolute; width: 100%; height: 2px; background: #ef4444; box-shadow: 0 0 10px #ef4444; animation: scan 1.5s infinite linear; display: none; z-index: 10; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        input[type="file"] { display: none; }
        .cropper-container { max-height: 70vh !important; }
        /* Transiciones suaves entre pestañas */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-24 bg-gray-100">

    <!-- Header -->
    <header class="bg-gray-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <h1 class="text-lg font-bold flex items-center gap-2 text-teal-400">
                <span class="material-icons-round">receipt_long</span>
                Reintegros Pro
            </h1>
            <button onclick="toggleConfigModal()" class="text-gray-400 hover:text-white transition">
                <span class="material-icons-round">settings</span>
            </button>
        </div>
    </header>

    <main class="max-w-2xl mx-auto p-4">

        <!-- ======================= -->
        <!-- VISTA 1: CAPTURA (FORM) -->
        <!-- ======================= -->
        <div id="view-capture" class="tab-content active space-y-4">
            
            <!-- Cámara y Foto -->
            <div class="bg-white rounded-xl shadow p-4 border border-gray-200">
                <div id="upload-placeholder" class="text-center py-6">
                    <div class="bg-teal-50 text-teal-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-icons-round text-3xl">camera_alt</span>
                    </div>
                    <h2 class="text-gray-800 font-bold">Capturar Factura</h2>
                    <p class="text-gray-500 text-sm mb-4">Usa una foto clara</p>
                    <label for="camera-input" class="inline-flex items-center gap-2 bg-teal-600 text-white px-6 py-3 rounded-full font-bold shadow-lg active:scale-95 transition cursor-pointer hover:bg-teal-700">
                        Abrir Cámara
                    </label>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                </div>

                <div id="preview-container" class="hidden relative">
                    <div class="relative rounded-lg overflow-hidden bg-gray-900 mb-3" style="min-height: 200px;">
                        <div class="scanner-line" id="scanner-line"></div>
                        <img id="image-preview" class="w-full object-contain mx-auto max-h-[400px]">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openCropper()" class="bg-indigo-100 text-indigo-700 py-2 px-4 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                            <span class="material-icons-round text-sm">crop</span> Recortar
                        </button>
                        <button onclick="resetImage()" class="bg-red-100 text-red-700 py-2 px-4 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                            <span class="material-icons-round text-sm">delete</span> Borrar
                        </button>
                    </div>
                    <!-- OCR status -->
                    <div id="ocr-status-container" class="hidden mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-teal-500 h-1.5 rounded-full transition-all" id="ocr-bar" style="width: 0%"></div></div>
                        <p class="text-xs text-gray-500 text-center mt-1" id="ocr-status-text">Leyendo...</p>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <form id="expense-form" class="bg-white rounded-xl shadow p-5 space-y-4 border border-gray-200" onsubmit="saveExpense(event)">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Fecha</label>
                        <input type="date" id="date" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm font-medium">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Doc. No.</label>
                        <div class="flex gap-1">
                            <input type="text" id="docNo" placeholder="---" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm font-mono">
                            <button type="button" onclick="triggerSpecificOCR('docNo')" class="bg-gray-200 rounded px-2"><span class="material-icons-round text-sm">crop_free</span></button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Descripción</label>
                    <input type="text" id="description" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Proyecto</label>
                        <select id="project" onchange="toggleOtherProject()" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm">
                            <option value="1bot">1bot</option>
                            <option value="BI">BI</option>
                            <option value="ATT">ATT</option>
                            <option value="Admin">Administración</option>
                            <option value="Otro">Otro...</option>
                        </select>
                        <input type="text" id="otherProjectInput" placeholder="Nombre..." class="hidden mt-1 w-full border rounded p-1 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Solicitante</label>
                        <input type="text" id="requester" value="Billy" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Valor (Q)</label>
                    <div class="relative flex items-center">
                        <span class="absolute left-3 text-gray-500 font-bold">Q</span>
                        <input type="number" id="amount" step="0.01" required placeholder="0.00" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 pl-8 text-xl font-bold text-gray-800">
                        <button type="button" onclick="triggerSpecificOCR('amount')" class="absolute right-2 bg-gray-200 rounded p-1.5"><span class="material-icons-round text-sm">paid</span></button>
                    </div>
                </div>

                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl shadow-lg flex justify-center items-center gap-2">
                    <span class="material-icons-round">save</span> Guardar
                </button>
            </form>

            <!-- Lista Pendiente -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                    <h3 class="font-bold text-gray-600 text-sm">Cola de Envío</h3>
                    <button onclick="clearData()" class="text-xs text-red-500">Borrar</button>
                </div>
                <div id="expense-list" class="divide-y divide-gray-100 max-h-40 overflow-y-auto">
                    <div class="p-4 text-center text-gray-400 text-xs">Vacío</div>
                </div>
                <div class="bg-gray-100 px-4 py-2 text-right font-bold text-sm" id="total-sum">Total: Q0.00</div>
                <button onclick="syncToSheet()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 flex justify-center gap-2 items-center">
                    <span class="material-icons-round">cloud_upload</span> Sincronizar Todo
                </button>
            </div>
        </div>

        <!-- ======================= -->
        <!-- VISTA 2: DASHBOARD (ADMIN) -->
        <!-- ======================= -->
        <div id="view-dashboard" class="tab-content space-y-4">
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-800">Resumen de Gastos</h2>
                    <button onclick="loadDashboardData()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                        <span class="material-icons-round text-sm">refresh</span> Actualizar
                    </button>
                </div>
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-xs text-blue-500 font-bold uppercase">Total Gastado</p>
                        <p class="text-xl font-bold text-blue-800" id="dash-total">Q0.00</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                        <p class="text-xs text-purple-500 font-bold uppercase">Registros</p>
                        <p class="text-xl font-bold text-purple-800" id="dash-count">0</p>
                    </div>
                </div>

                <!-- Gráfico -->
                <div class="h-48 mb-4 relative">
                    <canvas id="projectChart"></canvas>
                </div>

                <!-- Tabla Reciente -->
                <h3 class="font-bold text-gray-700 text-sm mb-2">Últimos Registros</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left text-gray-500">
                        <thead class="bg-gray-100 text-gray-700 uppercase">
                            <tr><th class="p-2">Fecha</th><th class="p-2">Desc</th><th class="p-2 text-right">Valor</th></tr>
                        </thead>
                        <tbody id="dash-table-body">
                            <tr><td colspan="3" class="p-2 text-center">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- NAVIGATION BAR -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 shadow-lg z-40 flex justify-around py-2">
        <button onclick="switchTab('capture')" class="flex flex-col items-center text-teal-600 w-full" id="nav-capture">
            <span class="material-icons-round">add_circle</span>
            <span class="text-[10px] font-bold">Captura</span>
        </button>
        <button onclick="switchTab('dashboard')" class="flex flex-col items-center text-gray-400 hover:text-blue-600 w-full" id="nav-dashboard">
            <span class="material-icons-round">dashboard</span>
            <span class="text-[10px] font-bold">Dashboard</span>
        </button>
    </nav>

    <!-- MODAL RECORTE -->
    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[60] hidden flex flex-col">
        <div class="flex-1 flex items-center justify-center p-4 overflow-hidden"><img id="image-to-crop" class="max-w-full"></div>
        <div class="bg-gray-900 p-4 flex gap-4"><button onclick="closeCropper()" class="flex-1 bg-gray-600 text-white py-3 rounded">Cancelar</button><button onclick="performCrop()" class="flex-1 bg-white text-black py-3 rounded font-bold">Recortar</button></div>
    </div>

    <!-- CONFIG MODAL -->
    <div id="config-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-5">
            <h3 class="font-bold mb-2">Configuración</h3>
            <label class="text-xs font-bold block mb-1">URL Script (Web App)</label>
            <input type="text" id="script-url-input" class="w-full border rounded p-2 text-xs mb-4">
            <label class="text-xs font-bold block mb-1">ID Hoja Google</label>
            <input type="text" id="sheet-id-input" class="w-full border rounded p-2 text-xs mb-4" value="19Dn2iYHZr9wrPYdNEI2t6QMLMSK-Ljshu_bpCyzgY78">
            <div class="flex justify-end gap-2"><button onclick="toggleConfigModal()" class="px-3 py-1">Cerrar</button><button onclick="saveConfig()" class="px-3 py-1 bg-teal-600 text-white rounded">Guardar</button></div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-80 z-[80] hidden flex flex-col items-center justify-center text-white">
        <div class="w-12 h-12 border-4 border-t-4 border-gray-200 rounded-full animate-spin mb-4" style="border-top-color: #14b8a6"></div>
        <p id="loading-text" class="font-bold">Procesando...</p>
    </div>

    <script>
        // CONFIGURACIÓN INICIAL
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        const DEFAULT_SCRIPT = "https://script.google.com/macros/s/AKfycbznuL-_Z-XYF9ArNIbRHkUXJuVYoUfpE59NAsHN1CsyOJLmWlfhWCubV2thUBj5uR5i/exec";
        let SCRIPT_URL = localStorage.getItem('googleScriptUrl') || DEFAULT_SCRIPT;
        let SHEET_ID = localStorage.getItem('googleSheetId') || "19Dn2iYHZr9wrPYdNEI2t6QMLMSK-Ljshu_bpCyzgY78";

        let originalImageFile = null;
        let compressedImageBase64 = null;
        let cropper = null;
        let myChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderList();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('script-url-input').value = SCRIPT_URL;
            document.getElementById('sheet-id-input').value = SHEET_ID;
        });

        // --- NAVEGACIÓN ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tab).classList.add('active');
            
            // Estilos botones
            const btnCap = document.getElementById('nav-capture');
            const btnDash = document.getElementById('nav-dashboard');
            
            if(tab === 'capture') {
                btnCap.classList.replace('text-gray-400', 'text-teal-600');
                btnDash.classList.replace('text-blue-600', 'text-gray-400');
            } else {
                btnDash.classList.replace('text-gray-400', 'text-blue-600');
                btnCap.classList.replace('text-teal-600', 'text-gray-400');
                loadDashboardData(); // Cargar datos al abrir
            }
        }

        // --- CORE: SINCRONIZACIÓN ROBUSTA (TEXT/PLAIN) ---
        function syncToSheet() {
            if(expenses.length === 0) { alert("Nada que subir"); return; }
            
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Enviando datos...";

            const payload = expenses.map(e => {
                const d = e.date.split('-');
                return {
                    formattedDate: `${d[2]}/${d[1]}`,
                    description: e.description,
                    docNo: e.docNo,
                    project: e.project,
                    amount: e.amount,
                    requester: e.requester,
                    image: e.image || ""
                };
            });

            // TRUCO: Enviamos como text/plain para evitar CORS Preflight
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify(payload)
            })
            .then(() => {
                overlay.classList.add('hidden');
                // Al ser no-cors, asumimos éxito si no hubo error de red
                if(confirm("✅ Envío completado.\n\nLos datos se enviaron a la cola de Google.\n\n¿Limpiar lista local?")) {
                    expenses = [];
                    localStorage.setItem('expenses', JSON.stringify([]));
                    renderList();
                }
            })
            .catch(err => {
                overlay.classList.add('hidden');
                alert("❌ Error de red: " + err);
            });
        }

        // --- DASHBOARD: LECTURA DE DATOS ---
        function loadDashboardData() {
            // Usamos Google Visualization API para leer la hoja DATA (pública o compartida)
            // Query: select D, F (Proyecto, Valor) where A is not null
            const query = encodeURIComponent("select A, B, F, D"); // Fecha, Desc, Valor, Proyecto
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=DATA&tq=${query}`;

            fetch(url)
            .then(res => res.text())
            .then(text => {
                // Limpiar respuesta rara de Google (/* ... */)
                const jsonText = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1];
                const json = JSON.parse(jsonText);
                const rows = json.table.rows;
                
                renderDashboard(rows);
            })
            .catch(err => console.error("Error cargando dashboard", err));
        }

        function renderDashboard(rows) {
            let total = 0;
            const projectMap = {};
            const tbody = document.getElementById('dash-table-body');
            tbody.innerHTML = "";

            // Procesar filas (empezar desde las ultimas para ver recientes)
            // Columnas GVIZ: 0=Fecha, 1=Desc, 2=Valor, 3=Proyecto
            
            // Invertir para ver lo último primero
            const recentRows = rows.slice().reverse().slice(0, 10); 

            rows.forEach(r => {
                const val = r.c[2] ? r.c[2].v : 0; // Valor
                const proj = r.c[3] ? r.c[3].v : "Otros"; // Proyecto
                total += val;
                projectMap[proj] = (projectMap[proj] || 0) + val;
            });

            // Render KPI
            document.getElementById('dash-total').innerText = `Q${total.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('dash-count').innerText = rows.length;

            // Render Tabla
            recentRows.forEach(r => {
                const fecha = r.c[0] ? (r.c[0].f || r.c[0].v) : "";
                const desc = r.c[1] ? r.c[1].v : "";
                const val = r.c[2] ? r.c[2].v : 0;
                
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${fecha}</td>
                        <td class="p-2 truncate max-w-[100px]">${desc}</td>
                        <td class="p-2 text-right font-bold text-teal-600">Q${val.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Render Chart
            const ctx = document.getElementById('projectChart').getContext('2d');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(projectMap),
                    datasets: [{
                        data: Object.values(projectMap),
                        backgroundColor: ['#14b8a6', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });
        }

        // --- MANEJO IMÁGENES Y OCR (IGUAL QUE ANTES) ---
        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            originalImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('image-preview').src = ev.target.result;
                document.getElementById('upload-placeholder').classList.add('hidden');
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('img-indicator').innerText = "Foto OK";
                document.getElementById('img-indicator').className = "text-xs text-green-600 bg-green-100 px-2 py-1 rounded";
            };
            reader.readAsDataURL(file);

            try {
                compressedImageBase64 = await compressImage(file);
                runOCR(file); // OCR Auto
            } catch(err) { console.log(err); }
        }

        async function runOCR(blob) {
            document.getElementById('ocr-status-container').classList.remove('hidden');
            const bar = document.getElementById('ocr-bar');
            
            try {
                const res = await Tesseract.recognize(blob, 'spa', {
                    logger: m => { if(m.status==='recognizing text') bar.style.width = (m.progress*100) + '%'; }
                });
                processOCR(res.data.text);
            } catch(e) { console.error(e); } 
            finally { setTimeout(() => document.getElementById('ocr-status-container').classList.add('hidden'), 1000); }
        }

        function processOCR(text) {
            const clean = text.replace(/[\r\n]+/g, '\n');
            
            // Regex ajustado para ignorar líneas dibujadas (__ or --)
            // Valor
            const money = clean.match(/(?:Q\s?)?([0-9]{1,3}(?:[,.][0-9]{3})*[.,][0-9]{2})/g);
            if(money) {
                const vals = money.map(v => parseFloat(v.replace(/[Q\s,]/g, '').replace(/(\d)\.(\d{3})/, '$1$2'))); // Basic cleanup
                // Mejor heurística: buscar el valor que parezca un total (el mayor)
                const max = Math.max(...vals.filter(n => !isNaN(n)));
                if(max > 0) document.getElementById('amount').value = max.toFixed(2);
            }
            
            // Fecha
            const date = clean.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
            if(date) {
                let y = date[3];
                if(y.length===2) y = "20"+y;
                document.getElementById('date').value = `${y}-${date[2].padStart(2,'0')}-${date[1].padStart(2,'0')}`;
            }

            // Doc
            const doc = clean.match(/(?:serie|no|dte|fac)[\D]{0,10}(\b[A-Z0-9\-]{5,}\b)/i);
            if(doc) document.getElementById('docNo').value = doc[1];
        }

        // --- CROPPER UTILS ---
        function openCropper() {
            if(!originalImageFile) return;
            const modal = document.getElementById('cropper-modal');
            const img = document.getElementById('image-to-crop');
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
                modal.classList.remove('hidden');
                if(cropper) cropper.destroy();
                cropper = new Cropper(img, { viewMode: 1, autoCropArea: 0.5 });
            };
            reader.readAsDataURL(originalImageFile);
        }
        function closeCropper() { document.getElementById('cropper-modal').classList.add('hidden'); if(cropper) cropper.destroy(); }
        function performCrop() {
            cropper.getCroppedCanvas().toBlob(blob => {
                closeCropper();
                runOCR(blob);
            });
        }
        function triggerSpecificOCR(field) {
            if(!originalImageFile) { alert("Falta foto"); return; }
            alert("Recorta la zona del dato");
            openCropper();
        }

        // --- UTILS LOCAL ---
        function saveExpense(e) {
            e.preventDefault();
            const proj = document.getElementById('project').value === 'Otro' ? document.getElementById('otherProjectInput').value : document.getElementById('project').value;
            
            expenses.push({
                id: Date.now(),
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                docNo: document.getElementById('docNo').value || "S/N",
                project: proj,
                amount: parseFloat(document.getElementById('amount').value),
                requester: document.getElementById('requester').value,
                image: compressedImageBase64
            });
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderList();
            resetImage();
            document.getElementById('description').value = "";
            document.getElementById('amount').value = "";
            document.getElementById('docNo').value = "";
        }

        function renderList() {
            const c = document.getElementById('expense-list');
            c.innerHTML = "";
            let t = 0;
            expenses.forEach(x => {
                t += x.amount;
                c.innerHTML += `
                <div class="p-3 border-b flex justify-between items-center">
                    <div>
                        <div class="font-bold text-sm text-gray-800">${x.description}</div>
                        <div class="text-xs text-gray-500">${x.date} | ${x.project}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-teal-600">Q${x.amount.toFixed(2)}</div>
                        <button onclick="del(${x.id})" class="text-xs text-red-400">X</button>
                    </div>
                </div>`;
            });
            document.getElementById('total-sum').innerText = `Total: Q${t.toFixed(2)}`;
        }

        function del(id) {
            if(confirm("¿Eliminar?")) {
                expenses = expenses.filter(x => x.id !== id);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                renderList();
            }
        }
        function clearData() { if(confirm("¿Borrar todo?")) { expenses=[]; localStorage.removeItem('expenses'); renderList(); } }
        function compressImage(f) {
            return new Promise((res, rej) => {
                const r = new FileReader(); r.readAsDataURL(f);
                r.onload = e => {
                    const i = new Image(); i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas');
                        const s = 800/i.width;
                        c.width = 800; c.height = i.height*s;
                        c.getContext('2d').drawImage(i,0,0,c.width,c.height);
                        res(c.toDataURL('image/jpeg', 0.6));
                    }
                }
            });
        }
        function resetImage() { 
            originalImageFile = null; compressedImageBase64 = null;
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('img-indicator').innerText = "Sin Foto";
            document.getElementById('img-indicator').className = "text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded";
        }
        function toggleOtherProject() {
            const p = document.getElementById('project');
            const i = document.getElementById('otherProjectInput');
            if(p.value==='Otro') i.classList.remove('hidden'); else i.classList.add('hidden');
        }
        function toggleConfigModal() { document.getElementById('config-modal').classList.toggle('hidden'); }
        function saveConfig() {
            SCRIPT_URL = document.getElementById('script-url-input').value;
            SHEET_ID = document.getElementById('sheet-id-input').value;
            localStorage.setItem('googleScriptUrl', SCRIPT_URL);
            localStorage.setItem('googleSheetId', SHEET_ID);
            toggleConfigModal();
        }
    </script>
</body>
</html>
